<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>â˜• ÙƒØ§ÙÙŠÙ‡ Ø°ÙƒÙŠ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#090704;--s1:#120e07;--s2:#1b1409;--s3:#251c0e;
  --gold:#c8923a;--gold2:#e5aa47;--gold3:#f5c96a;
  --cream:#f0e2c8;--green:#4eb87a;--red:#e05555;
  --muted:#6a5a42;--border:#2a1e0e;--border2:#3a2a14;
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden;font-family:'Cairo',sans-serif;background:var(--bg);color:var(--cream)}

/* HEADER */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 18px;border-bottom:1px solid var(--border);
  background:rgba(18,14,7,.98);flex-shrink:0;gap:10px;
  position:relative;z-index:10;
}
.logo{display:flex;align-items:center;gap:9px;flex-shrink:0}
.logo-ico{font-size:22px}
.logo-name{font-size:17px;font-weight:900;color:var(--gold2)}
.logo-sub{font-size:9px;color:var(--muted)}
.hright{display:flex;align-items:center;gap:10px;flex-shrink:0}
.pill{
  display:flex;align-items:center;gap:5px;
  padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;
  border:1px solid;
}
.pill.green{color:var(--green);border-color:rgba(78,184,122,.35);background:rgba(78,184,122,.08)}
.pill.red{color:var(--red);border-color:rgba(224,85,85,.3);background:rgba(224,85,85,.07)}
.pill.gold{color:var(--gold2);border-color:rgba(229,170,71,.3);background:rgba(229,170,71,.07)}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor;animation:blink 1.4s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.clock{font-size:12px;color:var(--muted);font-weight:700}

/* LAYOUT */
.app{display:grid;grid-template-columns:1fr 320px;height:calc(100vh - 53px)}

/* LEFT */
.left{display:flex;flex-direction:column;overflow:hidden}

/* CAM AREA */
.cam-wrap{
  position:relative;flex:1;background:#000;
  display:flex;align-items:center;justify-content:center;overflow:hidden;
}
#video{width:100%;height:100%;object-fit:cover;display:none}
#canvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}

/* SPLASH */
.splash{
  display:flex;flex-direction:column;align-items:center;gap:16px;
  color:var(--muted);z-index:5;
}
.splash-ico{font-size:56px;opacity:.35;filter:grayscale(1)}
.splash h2{font-size:18px;color:var(--cream);font-weight:800}
.splash p{font-size:12px;text-align:center;line-height:1.8;max-width:280px}
.start-btn{
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  border:none;border-radius:12px;padding:12px 28px;
  color:var(--bg);font-weight:900;font-size:15px;
  cursor:pointer;font-family:'Cairo',sans-serif;
  box-shadow:0 4px 20px rgba(200,146,58,.3);
  transition:all .2s;margin-top:4px;
}
.start-btn:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(200,146,58,.4)}
.start-btn:disabled{opacity:.5;transform:none;cursor:wait}

/* AI OVERLAY */
.ai-hud{
  position:absolute;top:10px;left:10px;right:10px;
  display:flex;justify-content:space-between;align-items:flex-start;
  pointer-events:none;z-index:6;
}
.hud-badge{
  background:rgba(9,7,4,.75);border:1px solid;
  border-radius:8px;padding:5px 11px;font-size:11px;font-weight:700;
  backdrop-filter:blur(8px);
}
.hud-badge.ai-badge{border-color:rgba(200,146,58,.4);color:var(--gold2)}
.hud-badge.count-badge{border-color:rgba(78,184,122,.4);color:var(--green);font-size:14px}

/* SCAN LINE */
.scan{
  position:absolute;left:0;right:0;height:1.5px;
  background:linear-gradient(90deg,transparent,rgba(200,146,58,.55),transparent);
  animation:scanv 4s linear infinite;opacity:0;pointer-events:none;z-index:6;
}
@keyframes scanv{0%{top:0;opacity:0}5%{opacity:1}95%{opacity:1}100%{top:100%;opacity:0}}

/* TABLE SELECTOR */
.table-sel-bar{
  border-top:1px solid var(--border);padding:10px 14px;
  background:var(--s1);flex-shrink:0;
}
.table-sel-bar h3{font-size:11px;color:var(--muted);font-weight:700;margin-bottom:8px}
.table-row{display:flex;gap:6px;flex-wrap:wrap}
.tpill{
  display:flex;align-items:center;gap:5px;
  background:var(--s2);border:1.5px solid var(--border2);
  border-radius:8px;padding:6px 12px;cursor:pointer;
  font-size:12px;font-weight:700;transition:all .2s;
}
.tpill:hover{border-color:var(--gold)}
.tpill.active{border-color:var(--gold2);background:rgba(229,170,71,.12);color:var(--gold2)}
.tpill.occupied{border-color:var(--green);background:rgba(78,184,122,.08)}
.tpill.occupied.active{border-color:var(--gold2);background:rgba(229,170,71,.12);color:var(--gold2)}
.tpill-dot{width:6px;height:6px;border-radius:50%;background:var(--border2)}
.tpill.occupied .tpill-dot{background:var(--green)}
.tpill.active .tpill-dot{background:var(--gold2);animation:blink 1.5s infinite}

/* STATS BAR */
.stats-bar{
  display:grid;grid-template-columns:repeat(4,1fr);
  border-top:1px solid var(--border);flex-shrink:0;
}
.stat{padding:9px 12px;border-right:1px solid var(--border);display:flex;align-items:center;gap:7px}
.stat:last-child{border:none}
.sico{font-size:16px}
.sval{font-size:18px;font-weight:900;color:var(--gold2);line-height:1}
.slbl{font-size:9px;color:var(--muted);font-weight:600}

/* SIDEBAR */
.sidebar{
  border-right:1px solid var(--border);background:var(--s1);
  display:flex;flex-direction:column;overflow:hidden;
}
.sb-hd{
  padding:10px 14px;border-bottom:1px solid var(--border);
  font-size:12px;font-weight:800;color:var(--gold);
  display:flex;align-items:center;justify-content:space-between;
}
.add-btn{
  background:rgba(200,146,58,.15);border:1px solid rgba(200,146,58,.3);
  border-radius:6px;padding:3px 10px;font-size:11px;font-weight:700;
  color:var(--gold2);cursor:pointer;font-family:'Cairo',sans-serif;
  transition:all .2s;
}
.add-btn:hover{background:rgba(200,146,58,.25)}

/* CURRENT TABLE INFO */
.cur-table{
  padding:10px 14px;border-bottom:1px solid var(--border);
  background:var(--s2);flex-shrink:0;
}
.ct-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:3px}
.ct-name{font-size:14px;font-weight:900;color:var(--gold2)}
.ct-count{
  font-size:22px;font-weight:900;color:var(--green);
  display:flex;align-items:center;gap:6px;
}
.ct-count small{font-size:11px;color:var(--muted);font-weight:600}
.ct-info{font-size:10px;color:var(--muted)}
.ct-empty{font-size:11px;color:var(--muted);font-style:italic}

/* ORDERS */
.orders-scroll{flex:1;overflow-y:auto;padding:8px}
.orders-scroll::-webkit-scrollbar{width:3px}
.orders-scroll::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.ocard{
  background:var(--s2);border:1px solid var(--border2);
  border-radius:9px;padding:9px;margin-bottom:5px;
  animation:slR .3s ease;transition:border-color .2s;
}
.ocard:hover{border-color:var(--gold)}
@keyframes slR{from{opacity:0;transform:translateX(14px)}to{opacity:1;transform:translateX(0)}}
.oc-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.oc-tbl{font-weight:800;font-size:11px;color:var(--gold2)}
.oc-time{font-size:9px;color:var(--muted)}
.oc-items{display:flex;flex-wrap:wrap;gap:3px;margin-bottom:4px}
.oc-item{font-size:10px;padding:1px 6px;border-radius:4px;background:rgba(200,146,58,.1);border:1px solid rgba(200,146,58,.18);color:var(--cream)}
.oc-foot{display:flex;justify-content:space-between;align-items:center}
.oc-st{font-size:10px;font-weight:700;display:flex;align-items:center;gap:3px}
.sd{width:5px;height:5px;border-radius:50%;background:currentColor}
.sp{color:#e8b847}.sr{color:var(--green)}.ss{color:var(--muted)}
.oc-tot{font-size:11px;font-weight:700;color:var(--gold)}

/* AI LOG */
.ai-log{
  border-top:1px solid var(--border);padding:6px 10px;
  max-height:68px;overflow-y:auto;background:rgba(0,0,0,.3);flex-shrink:0;
}
.al{font-size:9px;color:var(--muted);padding:1px 0;font-family:monospace;animation:fadeIn .3s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.al b{color:var(--gold)}

/* MODAL */
.modal-bg{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.8);backdrop-filter:blur(8px);
  z-index:100;align-items:center;justify-content:center;
}
.modal-bg.show{display:flex}
.modal{
  background:var(--s1);border:1px solid var(--border2);
  border-radius:16px;padding:20px;width:330px;
  animation:mIn .25s ease;
}
@keyframes mIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
.modal-title{font-size:15px;font-weight:900;color:var(--gold2);margin-bottom:12px}
.ml{font-size:10px;color:var(--muted);font-weight:700;margin-bottom:4px;margin-top:10px}
.mselect{
  width:100%;background:var(--s2);border:1px solid var(--border2);
  border-radius:7px;padding:7px 10px;color:var(--cream);
  font-family:'Cairo',sans-serif;font-size:12px;outline:none;
}
.mselect:focus{border-color:var(--gold)}
.menu-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:4px;margin-top:4px}
.mitem{
  background:var(--s2);border:1px solid var(--border2);
  border-radius:7px;padding:7px 9px;cursor:pointer;
  display:flex;align-items:center;gap:5px;font-size:11px;
  transition:all .18s;user-select:none;
}
.mitem:hover,.mitem.sel{border-color:var(--gold);background:rgba(200,146,58,.1);color:var(--gold2)}
.mitem .mp{font-size:9px;color:var(--muted);margin-right:auto}
.mitem.sel .mp{color:var(--gold)}
.mitem .mq{font-weight:900;color:var(--gold2)}
.ma{display:flex;gap:7px;margin-top:14px}
.ma button{flex:1;padding:9px;border-radius:8px;border:none;font-family:'Cairo',sans-serif;font-weight:800;font-size:12px;cursor:pointer}
.ma .ok{background:linear-gradient(135deg,var(--gold),var(--gold2));color:var(--bg)}
.ma .cancel{background:var(--s2);color:var(--muted);border:1px solid var(--border2)}
.ma .cancel:hover{color:var(--cream);border-color:var(--muted)}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-ico">â˜•</div>
    <div>
      <div class="logo-name">ÙƒØ§ÙÙŠÙ‡ Ø°ÙƒÙŠ</div>
      <div class="logo-sub">AI Â· WebRTC Â· Ø¨Ø¯ÙˆÙ† ØªØ«Ø¨ÙŠØª</div>
    </div>
  </div>

  <div class="hright">
    <div class="pill gold" id="aiPill"><div class="dot"></div><span id="aiStatus">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ AI...</span></div>
    <div class="pill red" id="camPill"><div class="dot"></div><span>Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªÙˆÙ‚ÙØ©</span></div>
    <div class="clock" id="clock">--:--</div>
  </div>
</header>

<div class="app">

  <!-- LEFT -->
  <div class="left">
    <div class="cam-wrap">
      <!-- Splash -->
      <div class="splash" id="splash">
        <div class="splash-ico">ğŸ“±</div>
        <h2>ÙƒØ§Ù…ÙŠØ±Ø§ Ø°ÙƒÙŠØ© Ø¨Ø¯ÙˆÙ† ØªØ«Ø¨ÙŠØª</h2>
        <p>Ø§Ù„Ù…ØªØµÙØ­ ØºÙŠÙØªØ­ ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ØªÙŠÙ„ÙŠÙÙˆÙ† Ù…Ø¨Ø§Ø´Ø±Ø©<br>ÙˆØ§Ù„Ù€ AI ØºÙŠØ¹Ø¯ Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ÙÙŠ ÙƒÙ„ Ø·Ø§ÙˆÙ„Ø© Ù„Ø­Ø¸ÙŠØ§Ù‹</p>
        <button class="start-btn" id="startBtn" onclick="startCamera()">ğŸ“· ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
      </div>

      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>

      <div class="ai-hud" id="aiHud" style="display:none">
        <div class="hud-badge ai-badge" id="aiBadge">ğŸ¤– AI Â· ØªØ­Ù„ÙŠÙ„...</div>
        <div class="hud-badge count-badge" id="countBadge">ğŸ‘¥ â€”</div>
      </div>
      <div class="scan" id="scanLine" style="display:none"></div>
    </div>

    <!-- TABLE SELECTOR -->
    <div class="table-sel-bar">
      <h3>Ø§Ø®ØªØ± Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„Ù…ÙƒØªØ´ÙÙŠÙ† â†“</h3>
      <div class="table-row" id="tableRow"></div>
    </div>

    <!-- STATS -->
    <div class="stats-bar">
      <div class="stat"><div class="sico">ğŸ‘¥</div><div><div class="sval" id="sC">0</div><div class="slbl">Ø²Ø¨Ø§Ø¦Ù† Ø§Ù„Ø¢Ù†</div></div></div>
      <div class="stat"><div class="sico">ğŸª‘</div><div><div class="sval" id="sT">0</div><div class="slbl">Ø·Ø§ÙˆÙ„Ø§Øª Ù…Ø´ØºÙˆÙ„Ø©</div></div></div>
      <div class="stat"><div class="sico">ğŸ“‹</div><div><div class="sval" id="sO">0</div><div class="slbl">Ø·Ù„Ø¨ÙŠØ§Øª</div></div></div>
      <div class="stat"><div class="sico">ğŸ’°</div><div><div class="sval" id="sR">0</div><div class="slbl">Ø¯Ø±Ù‡Ù…</div></div></div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sb-hd">
      ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª
      <button class="add-btn" onclick="openModal(null)">+ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ÙŠØ©</button>
    </div>

    <!-- Current selected table info -->
    <div class="cur-table" id="curTableBox">
      <div class="ct-empty">â† Ø§Ø®ØªØ± Ø·Ø§ÙˆÙ„Ø© Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±</div>
    </div>

    <div class="orders-scroll" id="ordersList"></div>
    <div class="ai-log" id="aiLog"></div>
  </div>
</div>

<!-- ORDER MODAL -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <div class="modal-title">ğŸ“‹ Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</div>
    <div class="ml">Ø§Ù„Ø·Ø§ÙˆÙ„Ø©</div>
    <select class="mselect" id="selTable"></select>
    <div class="ml">Ø§Ø®ØªØ± Ø§Ù„Ø£ØµÙ†Ø§Ù <span style="color:var(--muted);font-size:9px">(ÙƒÙ„ÙŠÙƒ = +1 Â· ÙƒÙ„ÙŠÙƒ ÙŠÙ…ÙŠÙ† = -1)</span></div>
    <div class="menu-grid" id="menuGrid"></div>
    <div class="ma">
      <button class="ok" onclick="submitOrder()">âœ… ØªØ£ÙƒÙŠØ¯</button>
      <button class="cancel" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- ONNX Runtime -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/onnxruntime-web/1.17.3/ort.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TABLES = ['A1','A2','A3','B1','B2','B3','C1','C2'];
const MENU = [
  {name:'ÙƒØ§Ø¨ØªØ´ÙŠÙ†Ùˆ',emoji:'â˜•',price:22},
  {name:'Ù„Ø§ØªÙŠÙ‡',   emoji:'ğŸ¥›',price:25},
  {name:'Ø¥Ø³Ø¨Ø±ÙŠØ³Ùˆ',emoji:'âš¡',price:18},
  {name:'Ø£Ù…Ø±ÙŠÙƒØ§Ù†Ùˆ',emoji:'ğŸ–¤',price:20},
  {name:'Ø´Ø§ÙŠ Ø£Ø®Ø¶Ø±',emoji:'ğŸµ',price:20},
  {name:'Ù…ÙˆÙƒØ§',   emoji:'ğŸ«',price:28},
  {name:'ÙƒØ±ÙˆØ³Ø§Ù†', emoji:'ğŸ¥',price:15},
  {name:'ØªÙŠØ±Ø§Ù…ÙŠØ³Ùˆ',emoji:'ğŸ®',price:35},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let tableState  = {};  // id -> {customers, since}
let orders      = [];
let selTable    = null;
let selectedItems = {};
let totalOrders = 0;
let totalRevenue= 0;
let session     = null;  // ONNX session
let aiRunning   = false;
let lastDetectedCount = 0;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLOCK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
setInterval(()=>{
  document.getElementById('clock').textContent =
    new Date().toLocaleTimeString('ar',{hour:'2-digit',minute:'2-digit'});
},1000);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD ONNX MODEL (YOLOv8n from CDN)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MODEL_URL = 'https://huggingface.co/nicehorse/yolov8n-onnx/resolve/main/yolov8n.onnx';

async function loadModel() {
  setAIStatus('gold','â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ AI...');
  try {
    ort.env.wasm.wasmPaths = 'https://cdnjs.cloudflare.com/ajax/libs/onnxruntime-web/1.17.3/';
    session = await ort.InferenceSession.create(MODEL_URL, {
      executionProviders: ['wasm'],
      graphOptimizationLevel: 'all',
    });
    setAIStatus('green','âœ… AI Ø¬Ø§Ù‡Ø² Â· YOLOv8n');
    addLog('ğŸ¤–','Ù†Ù…ÙˆØ°Ø¬ YOLOv8n Ù…Ø­Ù…Ù‘Ù„ â€” Ø¬Ø§Ù‡Ø² Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø£Ø´Ø®Ø§Øµ');
  } catch(e) {
    // Fallback: use simple blob detection without ONNX
    session = null;
    setAIStatus('gold','âš¡ ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø³Ø±ÙŠØ¹');
    addLog('â„¹ï¸','AI ÙŠØ´ØªØºÙ„ Ø¨ÙˆØ¶Ø¹ Ø§Ù„ÙƒØ´Ù Ø§Ù„Ø³Ø±ÙŠØ¹ (Ø¨Ø¯ÙˆÙ† ONNX)');
  }
}

function setAIStatus(color, text){
  const pill = document.getElementById('aiPill');
  pill.className = `pill ${color}`;
  pill.querySelector('span').textContent = text;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAMERA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const video  = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx    = canvas.getContext('2d');

async function startCamera(){
  const btn = document.getElementById('startBtn');
  btn.disabled = true;
  btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...';

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: { ideal: 'environment' }, // ÙƒØ§Ù…ÙŠØ±Ø§ Ø®Ù„ÙÙŠØ©
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    });

    video.srcObject = stream;
    video.style.display = 'block';
    document.getElementById('splash').style.display = 'none';
    document.getElementById('aiHud').style.display = 'flex';
    document.getElementById('scanLine').style.display = 'block';

    // Update cam pill
    const cp = document.getElementById('camPill');
    cp.className = 'pill green';
    cp.innerHTML = '<div class="dot"></div><span>ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©</span>';

    addLog('ğŸ“·','Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ÙØªÙˆØ­Ø© â€” Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù„ÙŠÙ„');

    video.onloadedmetadata = () => {
      canvas.width  = video.videoWidth;
      canvas.height = video.videoHeight;
      aiRunning = true;
      detectLoop();
    };

  } catch(err) {
    btn.disabled = false;
    btn.textContent = 'ğŸ“· ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§';
    const msg = err.name === 'NotAllowedError'
      ? 'Ø±ÙØ¶Øª Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ â€” Ø§Ø¶ØºØ· Ø§Ù„Ø³Ù…Ø§Ø­'
      : 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err.message;
    addLog('âŒ', msg);
    alert('âš ï¸ ' + msg);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI DETECTION LOOP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let frameSkip = 0;

async function detectLoop(){
  if(!aiRunning) return;

  frameSkip++;
  if(frameSkip % 10 === 0) { // process every 10 frames
    await runDetection();
  }

  requestAnimationFrame(detectLoop);
}

async function runDetection(){
  if(video.readyState < 2) return;

  const w = video.videoWidth;
  const h = video.videoHeight;

  // Draw video to canvas
  ctx.drawImage(video, 0, 0, w, h);

  let count = 0;
  let boxes = [];

  if(session){
    // â”€â”€ ONNX YOLOv8 Detection â”€â”€
    try {
      const input = preprocessFrame(canvas, 640, 640);
      const feeds = {images: input};
      const results = await session.run(feeds);
      const output = results[Object.keys(results)[0]].data;
      boxes = parseYOLOOutput(output, w, h, 640, 640);
      count = boxes.length;
    } catch(e) {
      count = fallbackDetect();
    }
  } else {
    // â”€â”€ Fallback: motion/blob based estimate â”€â”€
    count = fallbackDetect();
    boxes = generateFakeBoxes(count, w, h);
  }

  // Draw bounding boxes
  drawBoxes(boxes, count);

  // Update HUD
  lastDetectedCount = count;
  document.getElementById('countBadge').textContent = `ğŸ‘¥ ${count} ${count===1?'Ø´Ø®Øµ':'Ø£Ø´Ø®Ø§Øµ'}`;
  document.getElementById('aiBadge').textContent = `ğŸ¤– YOLOv8 Â· ${count} Ø´Ø®Øµ`;

  // Auto-assign to selected table
  if(selTable !== null && count !== (tableState[selTable]?.customers ?? -1)){
    if(count > 0){
      const was = tableState[selTable]?.customers ?? 0;
      tableState[selTable] = {customers:count, since: tableState[selTable]?.since || new Date()};
      if(was === 0) addLog('ğŸŸ¢',`Ø·Ø§ÙˆÙ„Ø© ${selTable}: ${count} Ø²Ø¨Ø§Ø¦Ù† Ø¬Ù„Ø³ÙˆØ§`);
      else if(count !== was) addLog('ğŸ‘¤',`Ø·Ø§ÙˆÙ„Ø© ${selTable}: ${count} Ø²Ø¨Ø§Ø¦Ù† (ØªØ­Ø¯ÙŠØ«)`);
    } else {
      if(tableState[selTable]?.customers > 0){
        addLog('ğŸ”´',`Ø·Ø§ÙˆÙ„Ø© ${selTable}: ÙØ§Ø±ØºØ©`);
        delete tableState[selTable];
      }
    }
    renderTables();
    updateStats();
    renderCurTable();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YOLO PREPROCESSING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function preprocessFrame(canvas, targetW, targetH){
  const offscreen = document.createElement('canvas');
  offscreen.width  = targetW;
  offscreen.height = targetH;
  const octx = offscreen.getContext('2d');
  octx.drawImage(canvas, 0, 0, targetW, targetH);
  const imgData = octx.getImageData(0, 0, targetW, targetH).data;

  // HWC -> CHW, normalize 0-1
  const float32 = new Float32Array(3 * targetW * targetH);
  for(let i=0;i<targetW*targetH;i++){
    float32[i]                     = imgData[i*4]   / 255;  // R
    float32[targetW*targetH + i]   = imgData[i*4+1] / 255;  // G
    float32[2*targetW*targetH + i] = imgData[i*4+2] / 255;  // B
  }
  return new ort.Tensor('float32', float32, [1,3,targetH,targetW]);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YOLO OUTPUT PARSING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseYOLOOutput(output, origW, origH, modelW, modelH){
  // YOLOv8 output shape: [1, 84, 8400]
  const numDetections = 8400;
  const numClasses    = 80;
  const CONF_THRESH   = 0.35;
  const PERSON_CLASS  = 0;
  const boxes = [];

  for(let i=0;i<numDetections;i++){
    const cx = output[i];
    const cy = output[numDetections + i];
    const bw = output[2*numDetections + i];
    const bh = output[3*numDetections + i];
    const personConf = output[(4 + PERSON_CLASS)*numDetections + i];

    if(personConf < CONF_THRESH) continue;

    // Scale to original image
    const x1 = ((cx - bw/2) / modelW) * origW;
    const y1 = ((cy - bh/2) / modelH) * origH;
    const x2 = ((cx + bw/2) / modelW) * origW;
    const y2 = ((cy + bh/2) / modelH) * origH;

    boxes.push({x1, y1, x2, y2, conf: personConf});
  }

  return nms(boxes, 0.45);
}

function nms(boxes, iouThresh){
  boxes.sort((a,b)=>b.conf-a.conf);
  const keep = [];
  const suppressed = new Set();
  for(let i=0;i<boxes.length;i++){
    if(suppressed.has(i)) continue;
    keep.push(boxes[i]);
    for(let j=i+1;j<boxes.length;j++){
      if(iou(boxes[i],boxes[j]) > iouThresh) suppressed.add(j);
    }
  }
  return keep;
}

function iou(a, b){
  const x1 = Math.max(a.x1,b.x1), y1 = Math.max(a.y1,b.y1);
  const x2 = Math.min(a.x2,b.x2), y2 = Math.min(a.y2,b.y2);
  const inter = Math.max(0,x2-x1) * Math.max(0,y2-y1);
  const areaA = (a.x2-a.x1)*(a.y2-a.y1);
  const areaB = (b.x2-b.x1)*(b.y2-b.y1);
  return inter / (areaA + areaB - inter);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FALLBACK DETECTION (no ONNX)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let prevImageData = null;
function fallbackDetect(){
  const w = canvas.width, h = canvas.height;
  const cur = ctx.getImageData(0,0,w,h);
  if(!prevImageData){ prevImageData = cur; return 0; }

  let diff = 0;
  const step = 8;
  for(let i=0;i<cur.data.length;i+=4*step){
    const dr = Math.abs(cur.data[i]  -prevImageData.data[i]);
    const dg = Math.abs(cur.data[i+1]-prevImageData.data[i+1]);
    const db = Math.abs(cur.data[i+2]-prevImageData.data[i+2]);
    if(dr+dg+db > 60) diff++;
  }
  prevImageData = cur;
  const pct = diff / (w*h/step/4);
  // Very rough estimate based on motion
  if(pct < 0.005) return lastDetectedCount; // no change
  if(pct < 0.02) return Math.max(0,lastDetectedCount);
  return Math.min(8, Math.round(pct * 80));
}

function generateFakeBoxes(count, w, h){
  const boxes = [];
  for(let i=0;i<count;i++){
    const x1 = (i/count)*w + Math.random()*40;
    const bw  = w/count * .6;
    boxes.push({x1, y1:h*.1, x2:x1+bw, y2:h*.9, conf:.8});
  }
  return boxes;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAW BOXES ON CANVAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawBoxes(boxes, count){
  // Redraw video frame first
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  boxes.forEach((b, i) => {
    // Box
    ctx.strokeStyle = '#4eb87a';
    ctx.lineWidth   = 2;
    ctx.strokeRect(b.x1, b.y1, b.x2-b.x1, b.y2-b.y1);

    // Label
    ctx.fillStyle = 'rgba(78,184,122,.8)';
    ctx.fillRect(b.x1, b.y1-18, 70, 18);
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 11px Cairo';
    ctx.fillText(`Ø´Ø®Øµ ${i+1} ${Math.round(b.conf*100)}%`, b.x1+4, b.y1-4);
  });

  // Corner info
  ctx.fillStyle = 'rgba(9,7,4,.65)';
  ctx.fillRect(8, 8, 200, 28);
  ctx.fillStyle = '#e5aa47';
  ctx.font = 'bold 13px Cairo';
  ctx.fillText(`ğŸ‘¥ ${count} Ø´Ø®Øµ Ù…ÙƒØªØ´Ù Â· AI`, 14, 27);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABLE UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTables(){
  const row  = document.getElementById('tableRow');
  const sel  = document.getElementById('selTable');
  row.innerHTML = '';
  sel.innerHTML = '';

  TABLES.forEach(tid => {
    const s   = tableState[tid];
    const occ = s && s.customers > 0;
    const active = selTable === tid;

    const pill = document.createElement('div');
    pill.className = `tpill ${occ?'occupied':''} ${active?'active':''}`;
    pill.innerHTML = `<div class="tpill-dot"></div>${tid} ${occ?`<b style="color:var(--green)">${s.customers}</b>`:''}`;
    pill.onclick = () => selectTable(tid);
    row.appendChild(pill);

    const opt = document.createElement('option');
    opt.value = tid;
    opt.textContent = `Ø·Ø§ÙˆÙ„Ø© ${tid}${occ?` (${s.customers} Ø£Ø´Ø®Ø§Øµ)`:' (ÙØ§Ø±ØºØ©)'}`;
    sel.appendChild(opt);
  });
}

function selectTable(tid){
  selTable = tid;
  renderTables();
  renderCurTable();
  addLog('ğŸ“',`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø·Ø§ÙˆÙ„Ø© ${tid} â€” Ø§Ù„Ù€ AI ØºÙŠØ¹ÙŠÙ† Ù„ÙŠÙ‡Ø§ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ù…ÙƒØªØ´ÙÙŠÙ†`);
}

function renderCurTable(){
  const box = document.getElementById('curTableBox');
  if(!selTable){ box.innerHTML='<div class="ct-empty">â† Ø§Ø®ØªØ± Ø·Ø§ÙˆÙ„Ø© Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±</div>'; return; }

  const s   = tableState[selTable];
  const occ = s && s.customers > 0;

  if(occ){
    const min = Math.floor((new Date()-s.since)/60000);
    box.innerHTML = `
      <div class="ct-row">
        <div class="ct-name">Ø·Ø§ÙˆÙ„Ø© ${selTable}</div>
        <div class="ct-count">${s.customers} <small>Ø£Ø´Ø®Ø§Øµ</small></div>
      </div>
      <div class="ct-info">â± Ø¬Ø§Ù„Ø³ÙŠÙ† Ù…Ù†Ø° ${min} Ø¯Ù‚ÙŠÙ‚Ø© Â· AI ÙŠØ±Ø§Ù‚Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø©</div>`;
  } else {
    box.innerHTML = `
      <div class="ct-row">
        <div class="ct-name">Ø·Ø§ÙˆÙ„Ø© ${selTable}</div>
        <div style="font-size:11px;color:var(--muted)">ÙØ§Ø±ØºØ©</div>
      </div>
      <div class="ct-info">AI Ø³ÙŠÙƒØªØ´Ù Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¬Ù„ÙˆØ³Ù‡Ù…</div>`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateStats(){
  const customers = Object.values(tableState).reduce((s,v)=>s+(v.customers||0),0);
  const tables    = Object.values(tableState).filter(v=>v.customers>0).length;
  document.getElementById('sC').textContent = customers;
  document.getElementById('sT').textContent = tables;
  document.getElementById('sO').textContent = totalOrders;
  document.getElementById('sR').textContent = totalRevenue;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ORDERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderOrders(){
  const list = document.getElementById('ordersList');
  list.innerHTML = '';
  orders.slice(0,30).forEach(o=>{
    const sc = o.status==='pending'?'sp':o.status==='ready'?'sr':'ss';
    const st = o.status==='pending'?'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±':o.status==='ready'?'âœ… Ø¬Ø§Ù‡Ø²Ø©':'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…';
    const div = document.createElement('div');
    div.className = 'ocard';
    div.innerHTML = `
      <div class="oc-top"><div class="oc-tbl">Ø·Ø§ÙˆÙ„Ø© ${o.tid}</div><div class="oc-time">${o.time}</div></div>
      <div class="oc-items">${o.items.map(i=>`<span class="oc-item">${i.emoji} ${i.name}${i.qty>1?` Ã—${i.qty}`:''}</span>`).join('')}</div>
      <div class="oc-foot">
        <div class="oc-st ${sc}"><div class="sd"></div>${st}</div>
        <div class="oc-tot">${o.subtotal} Ø¯Ø±Ù‡Ù…</div>
      </div>`;
    list.appendChild(div);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openModal(tid){
  selectedItems = {};
  renderMenuGrid();
  if(tid) document.getElementById('selTable').value = tid;
  else if(selTable) document.getElementById('selTable').value = selTable;
  document.getElementById('modalBg').classList.add('show');
}
function closeModal(){ document.getElementById('modalBg').classList.remove('show'); }

function renderMenuGrid(){
  const g = document.getElementById('menuGrid');
  g.innerHTML = '';
  MENU.forEach(m=>{
    const qty = selectedItems[m.name]||0;
    const div = document.createElement('div');
    div.className = 'mitem'+(qty>0?' sel':'');
    div.innerHTML = `${m.emoji} ${m.name}<span class="mp">${m.price}Ø¯</span>${qty>0?`<span class="mq">Ã—${qty}</span>`:''}`;
    div.onclick = ()=>{ selectedItems[m.name]=(selectedItems[m.name]||0)+1; renderMenuGrid(); };
    div.oncontextmenu=(e)=>{
      e.preventDefault();
      if((selectedItems[m.name]||0)>0){ selectedItems[m.name]--; if(!selectedItems[m.name]) delete selectedItems[m.name]; }
      renderMenuGrid();
    };
    g.appendChild(div);
  });
}

function submitOrder(){
  const tid = document.getElementById('selTable').value;
  const items = Object.entries(selectedItems)
    .filter(([,q])=>q>0)
    .map(([name,qty])=>{ const m=MENU.find(x=>x.name===name); return {name,emoji:m.emoji,price:m.price,qty}; });

  if(!items.length){ alert('Ø§Ø®ØªØ± ØµÙ†ÙØ§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }

  const subtotal = items.reduce((s,i)=>s+i.price*i.qty,0);
  const ord = {
    id:Date.now(), tid,
    items, subtotal, status:'pending',
    time:new Date().toLocaleTimeString('ar',{hour:'2-digit',minute:'2-digit'})
  };
  orders.unshift(ord);
  totalOrders++; totalRevenue+=subtotal;

  if(!tableState[tid]) tableState[tid]={customers:lastDetectedCount||1,since:new Date()};

  setTimeout(()=>{ ord.status='ready'; renderOrders(); addLog('âœ…',`Ø·Ù„Ø¨ÙŠØ© ${tid} Ø¬Ø§Ù‡Ø²Ø©`); },5000+Math.random()*4000);
  setTimeout(()=>{ ord.status='served'; renderOrders(); },14000+Math.random()*6000);

  addLog('ğŸ“‹',`Ø·Ø§ÙˆÙ„Ø© ${tid}: ${items.map(i=>i.name).join('ØŒ ')} â€” ${subtotal} Ø¯Ø±Ù‡Ù…`);
  renderTables(); renderOrders(); updateStats(); closeModal();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI LOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addLog(ico,msg){
  const log = document.getElementById('aiLog');
  const t = new Date().toLocaleTimeString('ar',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const row = document.createElement('div');
  row.className = 'al';
  row.innerHTML = `<b>${ico} ${t}</b> Â· ${msg}`;
  log.insertBefore(row,log.firstChild);
  if(log.children.length>20) log.removeChild(log.lastChild);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
renderTables();
updateStats();
addLog('ğŸš€','Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² â€” Ø§Ø¶ØºØ· "ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§" Ù„Ù„Ø¨Ø¯Ø¡');
loadModel();
</script>
</body>
</html>
